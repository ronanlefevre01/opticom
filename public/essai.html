<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Essai OptiCOM – 5 SMS offerts</title>
<style>
  :root{color-scheme:dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0f172a;color:#fff;margin:0}
  .wrap{max-width:720px;margin:40px auto;padding:24px}
  h1{margin:0 0 8px;font-size:28px;line-height:1.25}
  .card{background:#111827;border-radius:14px;padding:22px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
  input::placeholder{color:#94a3b8}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .hint{color:#94a3b8;font-size:14px;margin:8px 0 16px}
  button{background:#10b981;border:0;color:#fff;font-weight:700;padding:14px 18px;border-radius:10px;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .status{display:inline-block;margin-left:12px;padding:8px 10px;border-radius:8px;font-weight:600}
  .ok{background:#065f46}
  .err{background:#7f1d1d}
  @media (max-width:640px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Essai gratuit – 5 SMS offerts</h1>
  <p class="hint">Remplissez ce formulaire. Nous créons votre licence d’essai et vous envoyons vos accès par e-mail.</p>

  <div class="card">
    <form id="trialForm" novalidate>
      <label for="storeName">Nom du magasin</label>
      <input id="storeName" name="storeName" autocomplete="organization" required>

      <div class="row">
        <div>
          <label for="siret">SIRET</label>
          <input id="siret" name="siret" inputmode="numeric" pattern="\\d{14}" maxlength="14" placeholder="14 chiffres" required>
        </div>
        <div>
          <label for="phone">Téléphone</label>
          <input id="phone" name="phone" inputmode="tel" placeholder="ex : 06XXXXXXXX" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="email">E-mail</label>
          <input id="email" name="email" type="email" autocomplete="email" required>
        </div>
        <div>
          <label for="alias">Alias expéditeur (3–11 caractères)</label>
          <input id="alias" name="alias" maxlength="11" placeholder="ex : OPTICOM" required>
        </div>
      </div>

      <p class="hint">En validant, vous demandez la création <strong>manuelle</strong> d’une licence d’essai (5 SMS offerts).</p>
      <button type="submit" id="submitBtn">Envoyer la demande</button>
      <span id="status" class="status" aria-live="polite"></span>
    </form>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  // Utilise l'endpoint OptiComAdmin (mettre ton domaine si différent)
  const API_URL = 'https://opti-admin.vercel.app/api/trial-requests';

  // ---------- Utils ----------
  const qs = new URLSearchParams(location.search);
  const $ = (id) => document.getElementById(id);

  function normalizePhone(raw) {
    let p = String(raw || '').replace(/[^\d+]/g, '');
    if (p.startsWith('+33')) p = '0' + p.slice(3);
    return p.replace(/\D/g, '').slice(0, 10);
  }
  function validFRPhone(p) {
    return /^0[1-9]\d{8}$/.test(p);
  }
  function normalizeAlias(raw) {
    return String(raw || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 11);
  }

  // Pré-remplissage depuis l’URL (ex: .../essai.html?email=...&telephone=...&nom=...)
  (function prefill() {
    if (qs.get('email')) $('email').value = qs.get('email');
    if (qs.get('telephone')) $('phone').value = qs.get('telephone');
    if (qs.get('nom')) $('storeName').value = qs.get('nom');
  })();

  // Normalisations live
  $('alias').addEventListener('input', (e) => e.target.value = normalizeAlias(e.target.value));
  $('phone').addEventListener('blur', (e) => e.target.value = normalizePhone(e.target.value));
  $('siret').addEventListener('input', (e) => e.target.value = e.target.value.replace(/\D/g,'').slice(0,14));

  // ---------- Submit ----------
  $('trialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = $('status');
    const btn = $('submitBtn');
    status.className = 'status';
    status.textContent = '';

    const payload = {
      storeName: $('storeName').value.trim(),
      siret: $('siret').value.trim().replace(/\D/g,''),
      phone: normalizePhone($('phone').value),
      email: $('email').value.trim(),
      alias: normalizeAlias($('alias').value),
      source: 'email-essai'
    };

    // Validations
    if (!payload.storeName) return alert('Veuillez saisir le nom du magasin.');
    if (!/^\d{14}$/.test(payload.siret)) return alert('Le SIRET doit contenir 14 chiffres.');
    if (!validFRPhone(payload.phone)) return alert('Numéro de téléphone français invalide (ex: 06XXXXXXXX).');
    if (!payload.email.includes('@')) return alert('Adresse e-mail invalide.');
    if (payload.alias.length < 3 || payload.alias.length > 11) return alert('Alias expéditeur entre 3 et 11 caractères (A-Z et chiffres).');

    try {
      btn.disabled = true;
      status.textContent = 'Envoi…';

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors'
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      status.textContent = '✅ Demande envoyée. Vous recevrez vos accès par e-mail.';
      status.classList.add('ok');

      // Optionnel: reset du formulaire
      $('trialForm').reset();
    } catch (err) {
      console.error(err);
      status.textContent = '❌ Erreur lors de l’envoi. Réessayez ou contactez le support.';
      status.classList.add('err');
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
